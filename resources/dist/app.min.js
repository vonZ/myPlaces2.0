/*! myPlaces 2016-02-01 */
var app=angular.module("myApp",["ngRoute","ngAnimate","ui.bootstrap","naif.base64"]);app.controller("postCtrl",["$scope","posts","Map","$timeout","$location","$http","$q","$window","$rootScope",function(a,b,c,d,e,f,g,h,i){console.log("Inne i postCtrl"),a.tags=[];var j=this,k=!1;a.getCategories=function(){f.get("assets/mockdata.json").success(function(b){a.items=b,console.log("$scope.mockdata: ",a.category)})},a.onChange=function(a,b){console.log("this is on-change handler!")},a.onLoad=function(b,c,d,e,f,g){console.log("fileList: ",e),a.base64=g.base64,$(".boxContainer label").addClass("added")},a.files=[],a.getCategories(),a.place={},a.search=function(){a.apiError=!1,j.Map=search(a.searchPlace).then(function(b){j.Map=addMarker(b),a.place.name=b.name,a.place.lat=b.geometry.location.lat(),a.place.lng=b.geometry.location.lng()},function(b){a.apiError=!0,a.apiStatus=b})},a.initOnSwitch=function(){},a.loadMap=function(){a.overviewMap()},angular.element(document).ready(function(){a.overviewMap()}),a.overviewMap=function(){console.log("overviewMap"),j.Map=initOverviewMap(),console.log("$scope.posts i overviewMap(): ",a.posts),j.Map=overviewMap(a.posts)},a.mapSelected=function(){j.Map=refreshMap(),j.Map=overviewMap(a.posts)},a.initMap=function(){return k===!1&&(d(function(){j.Map=init()}),console.log("Map init"),k=!0),console.log("Map already init"),!1},a.getLocation=function(a){return f.get("//maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){return a.data.results.map(function(a){return a.formatted_address})})},a.getPosts=function(){a.loading=!0,f.get("/post").success(function(b){a.posts=b,console.log("$scope.posts i getPosts(): ",a.posts),a.loading=!1})},a.getPosts(),a.addPost=function(){function b(b){console.log("success"),a.getPosts()}function c(a){console.log("error: ",a)}if(a.loading=!0,""!==a.title){var d={title:a.title,description:a.description,category:a.category.name,tags:a.tags,searchPlaceLat:a.place.lat,searchPlaceLng:a.place.lng,searchPlaceName:a.place.name,image:a.base64};f({url:"/post/create",dataType:"json",method:"POST",headers:{"Content-Type":"application/json"},data:d}).then(b,c),a.title="",a.description="",a.category=[0],a.tags="",a.searchPlace=null,a.loading=!1}},a.incrementUpvotes=function(a){console.log("$scope.incrementUpvotes"),b.upvote(a)},a.deletePost=function(b){function c(c){console.log("DELETE SUCCESS");var d=a.posts.indexOf(b);a.posts.splice(d,1)}function d(){console.log("DELETE ERROR")}console.log("postId ",a.posts.indexOf(b));var e={id:a.posts.indexOf(b)};f({url:"/post/delete",dataType:"json",method:"POST",headers:{"Content-Type":"application/json"},data:e}).then(c,d)}}]),app.directive("loading",function(){return{restrict:"E",replace:!0,template:'<div class="respCenter loading"><span>Laddar</span><img src="images/ajax-loader.gif" class="respCenterIcon"/></div>',link:function(a,b,c){a.$watch("loading",function(a){a?$(b).show():$(b).hide()})}}}),app.factory("Map",["$q",function(a){return init=function(){var a={center:new google.maps.LatLng(59.3382028,18.07794190000004),zoom:13,disableDefaultUI:!0};this.map=new google.maps.Map(document.getElementById("map"),a),this.places=new google.maps.places.PlacesService(this.map)},search=function(b){var c=a.defer();return this.places.textSearch({query:b},function(a,b){"OK"==b?(c.resolve(a[0]),$(".boxContainer span").addClass("added")):c.reject(b)}),c.promise},addMarker=function(a){this.marker&&this.marker.setMap(null),this.marker=new google.maps.Marker({map:this.map,position:a.geometry.location,animation:google.maps.Animation.DROP}),this.map.setCenter(a.geometry.location)},initOverviewMap=function(){console.log("I initOverviewMap");var a={zoom:12,center:new google.maps.LatLng(59.3382028,18.07794190000004),zoomControl:!0};this.map=new google.maps.Map(document.getElementById("mapOverview"),a)},refreshMap=function(){console.log("I refreshMap"),window.setTimeout(function(){google.maps.event.trigger(map,"resize")})},overviewMap=function(a){console.log("I overviewMap"),console.log("post: ",a),this.markers=[];var b=new google.maps.InfoWindow,c=function(a){var c=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(a.searchPlaceLat,a.searchPlaceLng),title:a.title});c.content='<div class="infoWindowContent">'+a.category+", beläget på "+a.searchPlaceName+"</div>",google.maps.event.addListener(c,"click",function(){b.setContent("<h2>"+c.title+"</h2>"+c.content),b.open(this.map,c)}),this.markers.push(c)};for(i=0;i<a.length;i++)c(a[i])},Map}]),app.factory("posts",["$http",function(a){var b={posts:[]};return b.get=function(b){return console.log("get post"),a.get("/posts/"+b).then(function(a){return a.data})},b.getAll=function(){return console.log("get all posts"),a.get("/posts/").success(function(a){angular.copy(a,b.posts)})},b.upvote=function(b){return a.put("/posts/"+b._id+"/upvote").success(function(a){b.upvotes+=1})},b.deleteItem=function(b){return a.put("/posts/"+b._id+"/delete").success(function(a){console.log("success!")})},b.addComment=function(b,c){return console.log("add comment"),a.post("/posts/"+b+"/comments",c)},b.upvoteComment=function(b,c){return a.put("/posts/"+b._id+"/comments/"+c._id+"/upvote").success(function(a){c.upvotes+=1})},b}]);